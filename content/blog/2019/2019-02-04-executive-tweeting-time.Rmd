---
title: Executive Tweeting Time
author: ~
date: '2019-02-04'
slug: executive-tweeting-time
categories:
  - Blog
tags:
  - R
  - rtweet
  - ggplot2
  - Visualization
  - Politics
Description: ''
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE,
  fig.width = 9, fig.height = 10
)
```

```{r library, results="hide"}
library(tidyverse)
library(lubridate)
library(hrbrthemes)
library(showtext)
library(sysfonts)
```

```{r functions}
# Convert datetime to decimal hour of day
in_hours <- function(x) {
  hour(x) + minute(x)/60 + second(x)/60^2
}

am_pm <- function(x) {
  c(
    paste(x[x < 12], "am"),
    if (any(x == 12)) paste(x[x == 12], "pm"),
    paste(x[x > 12] - 12, "pm")
  )
}

# Reverse Time Axis
# thanks: https://stackoverflow.com/a/43626186
c_trans <- function(a, b, breaks = b$breaks, format = b$format) {
  library(scales)
  a <- as.trans(a)
  b <- as.trans(b)

  name <- paste(a$name, b$name, sep = "-")

  trans <- function(x) a$trans(b$trans(x))
  inv <- function(x) b$inverse(a$inverse(x))

  trans_new(name, trans, inverse = inv, breaks = breaks, format=format)

}

rev_date <- c_trans("reverse", "time")
```

```{r load-data}
# Load Data ---------------------------------------------------------------

# Exec Time Downloaded from https://docs.google.com/spreadsheets/d/1oITCuVsYdhNXtY7GElLelsrbjRRIPJ1ce-_v-8J1X_A/edit#gid=0

exec_time <-
  read_csv(
    here::here(
      "_data", "trump-exec-time",
      "axios_trump_schedule_2018-11-07--2019-02-02.csv"
    ),
    col_types = cols(.default = col_character())
  ) %>%
  mutate(
    time_start = paste(date, time_start),
    time_end   = paste(date, time_end),
    time_start = ymd_hm(time_start, tz = "America/New_York"),
    time_end   = ymd_hm(time_end, tz = "America/New_York"),
    time_end   = if_else(time_start > time_end, time_end + hours(24), time_end),
    time_inc   = map2(time_start, time_end, seq, by = "5 mins"),
    top_category = recode(
      top_category,
      "executive_time" = "Executive Time",
      "event"   = "Event",
      "lunch"   = "Lunch",
      "meeting" = "Meeting",
      "no_data" = "No Data",
      "travel"  = "Travel"),
    top_category = factor(
      top_category,
      levels = c(
        "Executive Time",
        "Event",
        "Meeting",
        "Lunch",
        "Travel",
        "No Data"
      ))
  ) %>%
  select(time_start, time_end, time_inc, listed_title, top_category)
```

```{r plot-daily-schedule}
# Plot --------------------------------------------------------------------
sysfonts::font_add_google("Fira Sans")
sysfonts::font_add_google("Fira Sans Condensed")
sysfonts::font_add_google("Fira Mono")
showtext::showtext_auto()

plot_date_breaks <- seq(
  from = ymd_h("2018-11-12 0", tz = "America/New_York"),
  to   = max(exec_time$time_start),
  by   = "7 day")

event_type_colors <- c(
  "Executive Time" = "#445566",
  "Event"   = "#ddbbaa",
  "Meeting" = "#b7c6d6",
  "Lunch"   = "#a1aab2",
  "Travel"  = "#997788",
  "No Data" = "#d9dde0")

exec_time %>%
  mutate(date = floor_date(time_start, "day")) %>%
  mutate_at(vars(time_start, time_end), in_hours) %>%
  ggplot() +
  geom_rect(
    aes(ymin = time_start,
        ymax = time_end,
        xmin = date,
        xmax = date + 3600 * 24,
        fill = top_category)
  ) +
  scale_y_continuous(
    breaks   = seq(8, 17, 3),
    limits   = c(8, 17),
    position = "bottom",
    labels   = am_pm(seq(8, 17, 3)),
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_x_continuous(
    trans  = rev_date,
    breaks = plot_date_breaks,
    labels = strftime(plot_date_breaks, "%b %e"),
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_fill_manual(values = event_type_colors) +
  coord_flip() +
  labs(y = "Hour of the Day", x = NULL, fill = NULL) +
  ggtitle(
    "How President Trump Has Spent His Time",
    "Daily Schedule Since Midterm Election"
  ) +
  labs(caption = paste(
    "Data: Based on White House schedules released by Axios. http://bit.ly/2UGM0fw",
    "Chart: @grrrck",
    sep = "\n"
  )) +
  guides(fill = guide_legend(nrow = 1, label.position = "top")) +
  hrbrthemes::theme_ipsum(
    base_family = "Fira Sans",
    axis_title_family = "Fira Sans Condensed",
    axis_title_size = 10,
    axis_text_size = 8,
    axis_title_just = "c"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.text.y = element_text(family = "Fira Mono", size = 8),
    legend.position = "bottom",
    legend.key = element_rect(fill = "white", color = "white", size = 5),
    legend.key.width = unit(2, "cm"),
    plot.caption = element_text(color = "#a1aab2", hjust = 0)
  )
```


```{r plot-time-categoy-pct}
# Plot 2 ------------------------------------------------------------------
exec_time_total <-
  exec_time %>%
  filter(between(hour(time_start), 8, 17), hour(time_end) < 17) %>%
  mutate(date = floor_date(time_start, "day")) %>%
  mutate(n = as.numeric(difftime(time_end, time_start, units = "mins"))) %>%
  group_by(date, top_category) %>%
  summarize(n = sum(n)) %>%
  ungroup() %>%
  mutate(n = n / (60 * 9)) %>%
  nest(-date) %>%
  mutate(
    total = map_dbl(data, ~ filter(., top_category != "No Data") %>% pull(n) %>% sum()),
    unaccounted = 1 - total,
  ) %>%
  unnest() %>%
  spread(top_category, n, fill = 0) %>%
  mutate(`No Data` =  unaccounted) %>%
  select(-total, -unaccounted) %>%
  gather("top_category", "n", -date) %>%
  mutate(top_category = factor(
      top_category,
      levels = rev(c(
        "Executive Time",
        "Event",
        "Meeting",
        "Lunch",
        "Travel",
        "No Data"
      )))
  )


ggplot(exec_time_total) +
  aes(date + 3600*12, n, fill = top_category) +
  geom_col(width = 3600*24) +
  scale_fill_manual(values = event_type_colors) +
  scale_y_continuous(
    breaks = seq(0, 1, .25),
    labels = scales::percent_format(accuracy = 25),
    position = "bottom",
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  scale_x_continuous(
    trans  = rev_date,
    breaks = plot_date_breaks,
    labels = strftime(plot_date_breaks, "%b %e"),
    expand   = expand_scale(c(0.025, 0), 0)
  ) +
  coord_flip() +
  labs(x = NULL, y = "Percent of Workday Between 8am and 5pm", fill = NULL) +
  guides(fill = guide_legend(nrow = 1, reverse = TRUE, label.position = "top")) +
  ggtitle(
    "What Does President Trump Do With His Time?"
  ) +
  labs(caption = paste(
    "Data: Based on White House schedules released by Axios. http://bit.ly/2UGM0fw",
    "Chart: @grrrck",
    sep = "\n"
  )) +
  hrbrthemes::theme_ipsum(
    base_family = "Fira Sans",
    axis_title_family = "Fira Sans Condensed",
    axis_title_size = 10,
    axis_text_size = 8,
    axis_title_just = "c"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.text.y = element_text(family = "Fira Mono", size = 8),
    legend.position = "bottom",
    legend.key = element_rect(fill = "white", color = "white", size = 5),
    legend.key.width = unit(2, "cm"),
    plot.caption = element_text(color = "#a1aab2", hjust = 0)
  )
```